name: Terraform AWS DNS Setup Module
#logo: logo/logo.jpg

license: "APACHE2"

copyrights:
  - name: "Cloud Ops Works LLC"
    url: "https://cloudops.works"
    year: "2024"

github_repo: cloudopsworks/terraform-module-aws-dns-setup

description: |-
  This Terraform module facilitates the deployment and management of DNS infrastructure on AWS. It handles the creation 
  of Route 53 zones (both public and private), configures Route 53 Resolver endpoints (inbound and outbound) for 
  hybrid cloud architectures, and manages custom resolver rules. The module is specifically designed for 
  hub-and-spoke network topologies, offering seamless integration with AWS Resource Access Manager (RAM) to share 
  DNS resolution capabilities across multiple AWS accounts within an organization.

introduction: |-
  The Terraform AWS DNS Setup module provides a centralized way to manage DNS across your AWS organization.
  Key features include:
  - **Zone Management**: Automated creation of private and public Route 53 Hosted Zones.
  - **Hybrid Connectivity**: Setup of Inbound and Outbound Resolver Endpoints for cross-environment DNS resolution.
  - **Resource Sharing**: Integration with AWS RAM for sharing resolver rules and endpoints with spoke accounts.
  - **Customizable Routing**: Support for custom resolver rules (FORWARD/SYSTEM) to direct traffic to on-premises or other DNS servers.
  - **VPC Integration**: Automated VPC association and authorization for private DNS zones.
  - **Scale and Control**: Support for multiple VPC associations and fine-grained control over resolver ENI placement.

usage: |-
  To implement this module using Terragrunt, configure your `terragrunt.hcl` with the necessary inputs. The module expects a structured configuration that can be represented in YAML format for clarity.
  
  ### Terragrunt Usage Example
  
  ```hcl
  terraform {
    source = "git::https://github.com/cloudopsworks/terraform-module-aws-dns-setup.git?ref=v1.0.0"
  }

  include "root" {
    path = find_in_parent_folders()
  }

  inputs = {
    # All variables are passed here
    org = {
      organization_name = "example"
      organization_unit = "platform"
      environment_type  = "prod"
      environment_name  = "production"
    }
    # ... other inputs ...
  }
  ```

  ### Full Configuration Schema (YAML Format)

  The following YAML structure represents the complete configuration options available for the module variables:

  ```yaml
  # --- Variables from variables.tf ---

  # is_hub: false                        # (Optional) Whether this instance acts as a DNS Hub. (Default: false)
  # spoke_def: "001"                     # (Optional) 3-digit spoke identifier. (Default: "001")
  # extra_tags:                          # (Optional) Extra tags to add to the resources. (Default: {})
  #   Tag1: "Value1"
  
  # org:                                 # (Required) Organization details
  #   organization_name: "example"       # (Required) The name of the organization.
  #   organization_unit: "platform"      # (Required) The organizational unit.
  #   environment_type: "prod"           # (Required) Type of environment (e.g., prod, non-prod).
  #   environment_name: "production"     # (Required) Specific environment name.

  # --- Variables from variables-dns.tf ---

  # zones:                               # (Optional) Map of Route53 zones to create.
  #   example-zone:
  #     domain_name: "example.com"      # (Required) The domain name of the Route53 zone.
  #     comment: "Example zone"         # (Optional) A comment for the Route53 zone. (Default: "Managed by Terraform")
  #     private: true                   # (Optional) Whether the zone is private or public. (Default: false)
  #     force_destroy: false            # (Optional) Whether to force destroy the zone even if it contains records. (Default: false)
  #     delegation_set_id: "N1234567"   # (Optional) The ID of the delegation set to use for the zone. (Default: null)
  #     tags:                           # (Optional) A map of tags to assign to the zone. (Default: {})
  #       Environment: "prod"

  # vpc_id: "vpc-12345678"               # (Optional) VPC ID to associate with the Route53 zones. Required for private zones.
  # vpc_cidr_block: "10.0.0.0/16"        # (Optional) CIDR block for the VPC. Required for private zones.
  # subnet_ids: ["subnet-1", "subnet-2"] # (Optional) List of subnet IDs where the DNS resolver will be deployed.
  
  # dns_vpc:                             # (Optional) VPC configuration for DNS resolver.
  #   vpc_id: "vpc-12345678"             # (Optional) VPC ID for the DNS resolver. (Default: "")
  #   vpc_region: "us-east-1"            # (Optional) AWS region for the DNS resolver. (Default: "us-east-1")

  # ram:                                 # (Optional) Resource Access Manager (RAM) configuration.
  #   enabled: true                      # (Optional) Enable Resource Access Manager (RAM) sharing. (Default: false)
  #   allow_external_principals: false   # (Optional) Allow sharing with external principals. (Default: false)
  #   principals: ["123456789012"]       # (Optional) List of AWS account IDs or OU ARNs to share with. (Default: [])

  # enable_auto_accept: true             # (Optional) Enable automatic acceptance of RAM shares. (Default: true)

  # shared:                              # (Optional) Shared configuration for the DNS resolver.
  #   ram_shares: {}                     # (Optional) RAM shares configuration. (Default: {})
  #   resolver_rules: {}                 # (Optional) Resolver rules configuration. (Default: {})

  # association_zone_ids:                # (Optional) List of Route53 zone IDs to associate with the DNS resolver.
  #   - "Z1234567890"

  # custom_resolver_rules:               # (Optional) Map of custom resolver rules to create.
  #   rule1:
  #     domain_name: "onprem.internal"   # (Required) Domain name for the resolver rule.
  #     rule_type: "FORWARD"             # (Optional) Type of resolver rule. (FORWARD, SYSTEM). (Default: FORWARD)
  #     addresses: ["10.0.0.1"]          # (Optional) Target IP addresses for the rule. (Default: inbound resolver IPs)
  #     associate_vpc: true              # (Optional) Whether to associate the rule with the VPC. (Default: false)

  # max_resolver_enis: -1                # (Optional) Maximum number of resolver ENIs to create. (Default: -1)
  ```

  ### Variable Specifications Table

  | Variable | Type | Required | Description |
  |----------|------|----------|-------------|
  | `org` | `object` | **Yes** | Organization details including name, unit, and environment info. |
  | `is_hub` | `bool` | No | Set to `true` to enable Hub features (resolver endpoints). Default: `false`. |
  | `zones` | `map(any)` | No | Configuration for Route 53 zones. |
  | `vpc_id` | `string` | No* | VPC ID for private zones and resolver endpoints. |
  | `vpc_cidr_block` | `string` | No* | CIDR block for the VPC. Required for private zones. |
  | `subnet_ids` | `list(string)` | No* | Subnet IDs for resolver endpoints (Required if `is_hub` is true). |
  | `dns_vpc` | `object` | No | VPC configuration for DNS resolver. |
  | `ram` | `object` | No | Configuration for AWS RAM sharing. |
  | `custom_resolver_rules` | `map(any)` | No | Custom DNS forwarding rules. |
  | `shared` | `object` | No | Shared resources for spoke accounts. |
  | `extra_tags` | `map(string)` | No | Additional tags for all resources. |

examples: |-
  ### Hub Configuration
  Deployment of a DNS Hub with Inbound/Outbound endpoints and RAM sharing to the organization.

  ```hcl
  terraform {
    source = "git::https://github.com/cloudopsworks/terraform-module-aws-dns-setup.git?ref=v1.0.0"
  }

  inputs = {
    org = {
      organization_name = "cloudops"
      organization_unit = "shared"
      environment_type  = "prod"
      environment_name  = "hub"
    }

    is_hub         = true
    vpc_id         = "vpc-0123456789abcdef0"
    vpc_cidr_block = "10.0.0.0/16"
    subnet_ids     = ["subnet-12345", "subnet-67890"]

    zones = {
      "cloudops.internal" = {
        domain_name = "cloudops.internal"
        private     = true
        comment     = "Main internal zone"
      }
    }

    ram = {
      enabled    = true
      principals = ["arn:aws:organizations::123456789012:ou/o-example/ou-1234"]
    }

    custom_resolver_rules = {
      "on-prem" = {
        domain_name = "internal.corp"
        rule_type   = "FORWARD"
        addresses   = ["172.16.0.10", "172.16.1.10"]
      }
    }
  }
  ```

  ### Spoke Configuration
  Deployment in a spoke account, associating with resolver rules shared from the Hub.

  ```hcl
  terraform {
    source = "git::https://github.com/cloudopsworks/terraform-module-aws-dns-setup.git?ref=v1.0.0"
  }

  inputs = {
    org = {
      organization_name = "cloudops"
      organization_unit = "engineering"
      environment_type  = "dev"
      environment_name  = "project-a"
    }

    is_hub = false
    vpc_id = "vpc-fedcba9876543210"

    shared = {
      resolver_rules = {
        "hub-rule" = {
          id          = "rslvr-rr-1234567890"
          domain_name = "cloudops.internal"
        }
      }
    }
  }
  ```

quickstart: |-
  Follow these steps to quickly deploy the DNS infrastructure:
  1. **Initialize Terragrunt**: Ensure you have `terragrunt.hcl` set up.
  2. **Define Inputs**: Fill in the `org`, `vpc_id`, and `zones` (for Hub) or `shared` (for Spoke).
  3. **Plan and Deploy**:
     ```bash
     terragrunt plan
     terragrunt apply
     ```
  4. **Verify**: Check Route 53 Resolver Rules and Zones in the AWS Console.

include:
  - "docs/targets.md"
  - "docs/terraform.md"

contributors:
  - name: "Cristian Beraha"
    github: "berahac"